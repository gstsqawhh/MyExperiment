<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/601392 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="978"/>
<h1>JMX介绍以及在项目中的使用</h1>

<div>
<span><div><div><span style="font-weight: bold; font-size: 14pt;">1、JMX定义</span></div><div><span style="font-size: 12pt;">    JMX全称</span><span style="font-size: 12pt;">Java Management Extensions，JMX技术是Java平台的标准组成部分，在Java1.5版本中首次被添加到Java平台中。</span><span style="font-size: 12pt;">JMX技术提供了一种简单、标准的方式来管理各种资源，例如应用、设备和服务等，以服务为例，当实现一个服务时，可以通过少量的修改来监控和管理该服。</span></div><div><span style="font-size: 12pt;">    JMX规范定义了一套架构、设计模式、API和服务，通过该规范来实现对应用和服务的监控和管理。</span></div><div><span style="font-size: 12pt;">    JMX有如下优点：</span></div><ul><li><div>易用性，框架使用简单，对已有应用地影响较小。</div></li><li><div>占用资源少，适用性广</div></li></ul><div><b style="font-size: 12pt;"><br/></b></div><div><span style="font-weight: bold; font-size: 12pt;">1.1 JMX架构</span></div><div><span style="font-size: 12pt;">    JMX架构由3个比较大的部分组成，对要管理和监控的应用的资源的封装、JMX服务代理、远程监控模块，架构图如下所示：</span></div><div><span style="font-size: 12pt;"><img src="JMX介绍以及在项目中的使用_files/Image.png" type="image/png" data-filename="Image.png" width="661"/></span></div><div><span style="font-size: 12pt;">    被封装的管理对象是指在Java应用或服务中，通过JMX的规定封装的MBean对象，全称&quot;</span><span style="font-size: 12pt;">Managed Beans</span><span style="font-size: 12pt;">&quot;，这些MBeans对象会注册到JMX服务代理的MBean server中，</span><span style="font-size: 12pt;">被封装地管理对象包括标准MBean、动态MBean和MXBean等不同地MBean类型，MBean需要按照JMX地规定实现，MBean除了被被动地管理外，MBean层实现了一种通知机制，可以主动通知JMX服务代理层</span><span style="font-size: 12pt;">；</span></div><div><span style="font-size: 12pt;">    JMX服务代理的核心就是MBean server，MBean server会通过管理API去管理MBean对象，并且为远程管理应用提供不同协议的连接适配器，这些连接适配器提供相同地管理接口，使得远程管理应用可以根据管理接口动态地修改被管理资源地一些属性，或者查看被管理资源地统计信息。</span></div><div><span style="font-size: 12pt;">远程管理应用如Java自带的JConsole或者开发的网页，由于JVM已经进行MBean封装，因此打开JConsole后可以直接查看JVM的相应信息。</span></div><div><span style="font-size: 12pt;">    Java本身自带标准JMX代理实现，只需要将被管理资源简单的注册到Java已经实现的JMX代理 MBean server中，即可通过JConsole管理资源。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; font-weight: bold;">2、标准MBean实现和使用</span></font></div><div><span style="font-size: 12pt;">    JMX共提供了5种类型的MBean(</span><span style="font-size: 12pt;">Standard MBeans、</span><span style="font-size: 12pt;">Dynamic MBeans、</span><span style="font-size: 12pt;">Open MBeans</span><span style="font-size: 12pt;">、Model MBeans</span><span style="font-size: 12pt;">、MXBeans</span><span style="font-size: 12pt;">)，以标准MBean为例来说明MBean的实现，MBean是一个可管理的Java对象，与普通的Java对象一样，但需要遵循JMX规范对该MBean申明一个管理接口，该管理接口包括两种类型的方法，一种方法是针对属性的get和set方法，一种方法普通的执行方法。Java普通对象在实现该接口，除此之外，MBean对应的接口需要以被管理对象的类名+MBean后缀作为接口的名称，这样就可以完成MBean的实现。具体实现代码如下：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.example;</div><div>public interface HelloMBean {</div><div>    public void sayHello();</div><div>    public int add(int x, int y);</div><div>    </div><div>    public String getName();</div><div>     </div><div>    public int getCacheSize();</div><div>    public void setCacheSize(int size);</div><div>}</div></div><div><span style="font-size: 12pt;">上述申明的接口中getName、getCacheSize和setCacheSize是针对属性的管理方法，其它是操作方法，可以被远程执行。</span></div><div><span style="font-size: 12pt;">实现Hello类实现HelloMBean类：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.example;</div><div>public class Hello ...</div><div>    implements HelloMBean {</div><div>    public void sayHello() {</div><div>        System.out.println(&quot;hello, world&quot;);</div><div>    }</div><div>     </div><div>    public int add(int x, int y) {</div><div>        return x + y;</div><div>    }</div><div>     </div><div>    public String getName() {</div><div>        return this.name;</div><div>    }  </div><div>     </div><div>    public int getCacheSize() {</div><div>        return this.cacheSize;</div><div>    }</div><div>     </div><div>    public synchronized void setCacheSize(int size) {</div><div>        ...</div><div>    </div><div>        this.cacheSize = size;</div><div>        System.out.println(&quot;Cache size now &quot; + this.cacheSize);</div><div>    }</div><div>    ...</div><div>     </div><div>    private final String name = &quot;Reginald&quot;;</div><div>    private int cacheSize = DEFAULT_CACHE_SIZE;</div><div>    private static final int</div><div>        DEFAULT_CACHE_SIZE = 200;</div><div>}</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">完成了标准MBean的实现后，再来实现JMX代理，并将MBean注册到JMX代理的MBean server上进行管理，代码如下：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.example;</div><div>import java.lang.management.*;</div><div>import javax.management.*;</div><div>public class Main {</div><div>    public static void main(String[] args)</div><div>        throws Exception {</div><div>     </div><div>        MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();</div><div>        ObjectName name = new ObjectName(&quot;com.example:type=Hello&quot;);</div><div>        Hello mbean = new Hello();</div><div>        mbs.registerMBean(mbean, name);</div><div>          </div><div>        ...</div><div>     </div><div>        System.out.println(&quot;Waiting forever...&quot;);</div><div>        Thread.sleep(Long.MAX_VALUE);</div><div>    }</div><div>}</div></div><div><span style="font-size: 12pt;">再上述代码中，通过</span><span style="font-size: 12pt;">ManagementFactory创建或获取MBean Server，需要注意的是，ObjectName的命名需要遵循一定的规范，使用domain为com.example，后面跟上key value的properties对，此处设置为type为Hello。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; font-weight: bold;">3、MXBean的实现和使用</span></font></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">MXBean提供一种方式以数据结构的方式将一组相关的对象放在一起管理，远程管理应用不需要知道该数据结构对象的信息，因为JMX通过转换的方式将该结构化的对象转换为了一个公共的</span> <span style="font-size: 12pt;">CompositeDataSupport对象，查看该对象的构造函数实现可以发现底层是一个Map数据结构，</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div>CompositeDataSupport(CompositeType compositeType, <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">Map&lt;String,?&gt; items</span>)</div><div>Constructs a CompositeDataSupport instance with the specified compositeType, whose item names and corresponding values are given by the mappings in the map items.</div><div>CompositeDataSupport(CompositeType compositeType, <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">String[] itemNames, Object[] itemValues</span>)</div><div>Constructs a CompositeDataSupport instance with the specified compositeType, whose item values are specified by itemValues[], in the same order as in itemNames[].</div><div><br/></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">另外与标准MBean不同的是，定义MXBean时可以直接通过申明@MXBean标记来实现，而不用通过后缀的方式，具体实现和使用MXBean的方式与标准MBean基本一致。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.example;</div><div>import javax.management.*;</div><div>@MXBean</div><div>public interface QueueSamplerMXBean {</div><div>    public QueueSample getQueueSample();</div><div>    public void clearQueue();</div><div>}</div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">可以看到上述get方法针对的属性时一个名为QueueSample的数据结构对象，为了使得它和JMX底层使用的</span><span style="font-size: 12pt;">CompositeDataSupport</span></div><div><span style="font-size: 12pt;">相互转换，JMX MXBean框架使用get方法将</span><span style="font-size: 12pt;">QueueSample转换为通用的</span><span style="font-size: 12pt;">CompositeDataSupport，而通过</span><span style="font-size: 12pt;">在构造函数上加上</span><span style="font-size: 12pt;">@ConstructorProperties将</span><span style="font-size: 12pt;">CompositeDataSupport重新构造为</span><span style="font-size: 12pt;">QueueSample，代码如下：</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.example;</div><div>import java.beans.ConstructorProperties;</div><div>import java.util.Date;</div><div>public class QueueSample {</div><div>     </div><div>    private final Date date;</div><div>    private final int size;</div><div>    private final String head;</div><div>         </div><div>    @ConstructorProperties({&quot;date&quot;, &quot;size&quot;, &quot;head&quot;})</div><div>    public QueueSample(Date date, int size,</div><div>                        String head) {</div><div>        this.date = date;</div><div>        this.size = size;</div><div>        this.head = head;</div><div>    }</div><div>         </div><div>    public Date getDate() {</div><div>        return date;</div><div>    }</div><div>         </div><div>    public int getSize() {</div><div>        return size;</div><div>    }</div><div>         </div><div>    public String getHead() {</div><div>        return head;</div><div>    }</div><div>}   </div></div><div><span style="font-size: 12pt;"><br/></span></div><div><font style="font-size: 14pt;"><span style="font-size: 14pt; font-weight: bold;">4、动态MBean的实现和使用</span></font></div><div><font style="font-size: 12pt;"><b>TODO</b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 